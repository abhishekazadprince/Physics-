<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Advanced Scientific Simulation Laboratory">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Raju's FDE Lab: Scientific Universe V11</title>
    
    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* CORE RESET & LAYOUT */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --bg-color: #000; --text-color: #fff; --glass-bg: rgba(8, 10, 20, 0.95); --panel-bg: rgba(255,255,255,0.03); --border: rgba(255,255,255,0.1); }
        .theme-light { --bg-color: #f8fafc; --text-color: #0f172a; --glass-bg: rgba(255, 255, 255, 0.95); --panel-bg: rgba(0,0,0,0.03); --border: rgba(0,0,0,0.1); }
        
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow: hidden; height: 100dvh; width: 100vw; margin: 0; padding: 0; position: fixed; transition: background 0.3s, color 0.3s; }
        
        /* VIEWS - Fixed Positioning */
        #view-home, #view-sim { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; backface-visibility: hidden; will-change: transform; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); background: var(--bg-color); }
        #view-sim { transform: translateX(100%); z-index: 50; }
        
        /* CANVAS */
        canvas { display: block; width: 100%; height: 100%; touch-action: none; }
        
        /* UI LAYERS */
        .glass { background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid var(--border); box-shadow: 0 -10px 40px rgba(0,0,0,0.1); }
        .glass-panel { background: var(--panel-bg); border: 1px solid var(--border); backdrop-filter: blur(4px); }
        
        /* UTILS */
        .neon-text { text-shadow: 0 0 10px currentColor; }
        .theme-light .neon-text { text-shadow: none; font-weight: 800; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* TYPOGRAPHY */
        .prose-sci p { margin-bottom: 0.85rem; line-height: 1.7; font-size: 0.85rem; opacity: 0.8; }
        .prose-sci h4 { color: #22d3ee; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.75rem; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.08em; border-bottom: 1px solid var(--border); padding-bottom: 0.25rem; }
        .theme-light .prose-sci h4 { color: #0284c7; }
        .prose-sci ul { list-style-type: disc; padding-left: 1rem; margin-bottom: 1rem; font-size: 0.8rem; opacity: 0.7; }
        .prose-sci li { margin-bottom: 0.4rem; }

        /* SLIDERS & GRIDS */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #06b6d4; margin-top: -6px; box-shadow: 0 0 10px #06b6d4; cursor: grab; transition: transform 0.1s; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #334155; border-radius: 2px; }
        .theme-light input[type=range]::-webkit-slider-runnable-track { background: #cbd5e1; }
        
        .phase-grid { background-image: radial-gradient(circle, var(--border) 1px, transparent 1px); background-size: 20px 20px; }
        .spec-grid { background: linear-gradient(var(--border) 1px, transparent 1px), linear-gradient(90deg, var(--border) 1px, transparent 1px); background-size: 40px 40px; }
        
        /* CUSTOM EQ INPUT */
        .code-input { font-family: 'Fira Code', monospace; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #4ade80; border-radius: 0.5rem; padding: 0.5rem; width: 100%; font-size: 0.75rem; outline: none; }
        .theme-light .code-input { background: rgba(255,255,255,0.8); color: #166534; border-color: #cbd5e1; }
        
        /* CINEMA MODE */
        .cinema-hidden { opacity: 0; pointer-events: none; transition: opacity 0.5s; }
    </style>
</head>
<body>

<!-- HOME VIEW -->
<div id="view-home" class="flex flex-col">
    <header class="p-6 safe-top bg-gradient-to-b from-slate-900 to-black border-b border-white/10 relative overflow-hidden shrink-0 transition-colors duration-300" id="home-header">
        <div class="absolute top-0 right-0 p-4 opacity-20"><i class="fas fa-atom text-6xl text-cyan-500"></i></div>
        <h1 class="text-3xl font-bold bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-500 bg-clip-text text-transparent relative z-10">Raju's FDE Lab</h1>
        <p class="text-[10px] mt-1 tracking-[0.2em] font-bold uppercase relative z-10 opacity-70">Scientific Universe V11</p>
    </header>
    
    <div class="flex-1 overflow-y-auto p-4 space-y-8 safe-bottom relative z-10" id="algo-list">
        <!-- JS Populated -->
    </div>
</div>

<!-- SIMULATION VIEW -->
<div id="view-sim" class="flex flex-col">
    
    <canvas id="simCanvas" class="absolute inset-0 z-0 cursor-crosshair"></canvas>

    <!-- OVERLAY UI -->
    <div class="absolute inset-0 z-10 flex flex-col pointer-events-none" id="ui-layer">
        
        <!-- HEADER -->
        <div id="sim-header" class="pointer-events-auto bg-gradient-to-b from-black/90 via-black/60 to-transparent p-3 safe-top flex items-center justify-between transition-all duration-500 backdrop-blur-sm">
            <button onclick="goBack()" class="w-9 h-9 rounded-full bg-white/10 backdrop-blur flex items-center justify-center active:bg-white/20 transition hover:bg-white/20 hover:scale-105 border border-white/5 shadow-lg">
                <i class="fas fa-arrow-left text-sm"></i>
            </button>
            
            <div class="text-center">
                <div id="sim-title" class="text-[10px] font-black text-cyan-400 neon-text tracking-widest uppercase mb-0.5">SIMULATION</div>
                <div class="flex gap-2 justify-center">
                    <span class="text-[8px] opacity-70 font-mono bg-white/5 px-1.5 py-0.5 rounded border border-white/5" id="sim-status">INIT</span>
                    <span class="text-[8px] text-yellow-400 font-mono hidden bg-yellow-900/30 px-1.5 py-0.5 rounded border border-yellow-500/30" id="rec-status">REC ●</span>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="toggleCinema()" class="w-9 h-9 rounded-full bg-white/10 backdrop-blur flex items-center justify-center active:bg-white/20 transition hover:bg-white/20 border border-white/5" title="Cinema Mode">
                    <i class="fas fa-expand text-xs opacity-70"></i>
                </button>
                <button onclick="toggleTheme()" class="w-9 h-9 rounded-full bg-white/10 backdrop-blur flex items-center justify-center active:bg-white/20 transition hover:bg-white/20 border border-white/5" title="Theme">
                    <i class="fas fa-sun text-xs opacity-70"></i>
                </button>
                <button onclick="toggleRecording()" id="btn-rec" class="w-9 h-9 rounded-full bg-white/10 backdrop-blur flex items-center justify-center active:bg-white/20 transition hover:bg-white/20 border border-white/5 text-red-400" title="Record Video">
                    <i class="fas fa-video text-xs"></i>
                </button>
                <button onclick="toggleAudio()" id="btn-audio" class="w-9 h-9 rounded-full bg-white/10 backdrop-blur flex items-center justify-center active:bg-white/20 transition hover:bg-white/20 border border-white/5" title="Sonification">
                    <i class="fas fa-volume-mute text-xs opacity-70"></i>
                </button>
                <button onclick="toggleFocusMode()" class="w-9 h-9 rounded-full bg-white/10 backdrop-blur flex items-center justify-center active:bg-white/20 transition hover:bg-white/20 border border-white/5" title="Focus Mode">
                    <i class="fas fa-eye text-xs opacity-70"></i>
                </button>
                <button onclick="togglePause()" id="play-btn" class="w-9 h-9 rounded-full bg-cyan-500 text-black shadow-[0_0_15px_rgba(6,182,212,0.4)] flex items-center justify-center active:scale-95 transition hover:bg-cyan-400 hover:scale-105 border border-cyan-300">
                    <i class="fas fa-pause text-xs"></i>
                </button>
            </div>
        </div>

        <!-- TOAST -->
        <div id="toast" class="absolute top-20 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs px-4 py-2 rounded-full shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none border border-white/10 flex items-center gap-2 z-50">
            <i class="fas fa-info-circle text-cyan-400"></i> <span id="toast-msg">Notification</span>
        </div>

        <!-- TIMELINE OVERLAY -->
        <div id="overlay-container" class="flex-1 pointer-events-none relative">
             <div id="timeline-ui" class="absolute bottom-4 left-4 right-4 pointer-events-auto hidden transition-all duration-300">
                 <div class="glass-panel p-4 rounded-xl shadow-2xl">
                     <div class="flex justify-between text-[9px] opacity-70 mb-2 font-mono tracking-wider">
                         <span>ARYABHATA (476 CE)</span>
                         <span>FUTURE (FDE)</span>
                     </div>
                     <input type="range" id="timeline-slider" min="0" max="4" step="1" value="0" class="w-full h-2 mb-3">
                     <div id="timeline-info" class="text-xs text-center text-cyan-500 min-h-[3rem] flex items-center justify-center font-bold leading-tight px-4 border-l-2 border-cyan-500/50 bg-cyan-500/10 rounded-r"></div>
                 </div>
             </div>
        </div>

        <!-- DRAWER -->
        <div id="drawer" class="pointer-events-auto h-[60vh] glass rounded-t-3xl flex flex-col shadow-[0_-10px_50px_rgba(0,0,0,0.2)] translate-y-[0] transition-transform duration-500 ease-out">
            <div class="w-full h-6 flex items-center justify-center cursor-pointer hover:bg-white/5 transition group" onclick="toggleDrawer()">
                <div class="w-10 h-1 bg-white/20 rounded-full group-hover:bg-cyan-400/50 transition-colors"></div>
            </div>

            <!-- TABS -->
            <div class="flex border-b border-white/10 px-2 overflow-x-auto no-scrollbar">
                <button onclick="setTab('controls')" class="tab-btn shrink-0 px-4 py-3 text-[9px] font-bold tracking-widest text-cyan-400 border-b-2 border-cyan-400 hover:opacity-70 transition">CONTROLS</button>
                <button onclick="setTab('phase')" class="tab-btn shrink-0 px-4 py-3 text-[9px] font-bold tracking-widest text-purple-400 border-b-2 border-transparent hover:opacity-70 transition"><i class="fas fa-project-diagram mr-1"></i>PHASE</button>
                <button onclick="setTab('poincare')" class="tab-btn shrink-0 px-4 py-3 text-[9px] font-bold tracking-widest text-orange-400 border-b-2 border-transparent hover:opacity-70 transition"><i class="fas fa-braille mr-1"></i>POINCARÉ</button>
                <button onclick="setTab('graph')" class="tab-btn shrink-0 px-4 py-3 text-[9px] font-bold tracking-widest opacity-60 border-b-2 border-transparent hover:opacity-100 transition">GRAPH</button>
                <button onclick="setTab('bifurcation')" class="tab-btn shrink-0 px-4 py-3 text-[9px] font-bold tracking-widest text-green-400 border-b-2 border-transparent hover:opacity-70 transition"><i class="fas fa-code-branch mr-1"></i>BIFUR</button>
                <button onclick="setTab('spectrum')" class="tab-btn shrink-0 px-4 py-3 text-[9px] font-bold tracking-widest text-pink-400 border-b-2 border-transparent hover:opacity-70 transition"><i class="fas fa-wave-square mr-1"></i>FFT</button>
                <button onclick="setTab('data')" class="tab-btn shrink-0 px-4 py-3 text-[9px] font-bold tracking-widest opacity-60 border-b-2 border-transparent hover:opacity-100 transition">DATA</button>
                <button onclick="setTab('series')" id="tab-btn-series" class="tab-btn shrink-0 px-4 py-3 text-[9px] font-bold tracking-widest opacity-60 border-b-2 border-transparent hidden hover:opacity-100 transition">SERIES</button>
                <button onclick="setTab('compare')" id="tab-btn-compare" class="tab-btn shrink-0 px-4 py-3 text-[9px] font-bold tracking-widest opacity-60 border-b-2 border-transparent hidden hover:opacity-100 transition">COMPARE</button>
                <button onclick="setTab('info')" class="tab-btn shrink-0 px-4 py-3 text-[9px] font-bold tracking-widest text-yellow-400 border-b-2 border-transparent hover:opacity-70 transition"><i class="fas fa-book mr-1"></i>GUIDE</button>
            </div>

            <!-- TAB CONTENT -->
            <div class="flex-1 overflow-y-auto p-5 relative safe-bottom">
                
                <!-- 1. CONTROLS -->
                <div id="tab-controls" class="space-y-5">
                    <div class="glass-panel p-3 rounded-lg text-center min-h-[50px] flex items-center justify-center shadow-inner">
                        <div id="katex-eq" class="text-sm"></div>
                    </div>
                    
                    <!-- CUSTOM EQ INPUT -->
                    <div id="custom-eq-panel" class="hidden space-y-2">
                        <div class="text-[9px] font-bold opacity-70">CUSTOM MODEL DEFINITION</div>
                        <div class="text-[8px] opacity-50">dx/dt = </div>
                        <textarea id="inp-custom-dx" rows="1" class="code-input" spellcheck="false">return v;</textarea>
                        <div class="text-[8px] opacity-50">dv/dt = </div>
                        <textarea id="inp-custom-dv" rows="1" class="code-input" spellcheck="false">return -k*x - 0.1*v;</textarea>
                        <div class="text-[8px] opacity-50 italic">Vars: x, v, t, k, tau, x_old, v_old.</div>
                        <button onclick="applyCustomEq()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white text-[9px] py-1 rounded font-bold">COMPILE MODEL</button>
                    </div>

                    <div class="space-y-2">
                        <div class="text-[9px] opacity-60 font-bold tracking-widest uppercase">Quick Presets</div>
                        <div id="preset-container" class="flex flex-wrap gap-2"></div>
                    </div>

                    <div id="3d-controls" class="glass-panel p-3 rounded-lg flex flex-col gap-2 border-l-4 border-yellow-500/50">
                        <div class="flex justify-between items-center">
                             <span class="text-[10px] text-yellow-500 font-bold"><i class="fas fa-cube mr-1"></i> 3D VISUALIZATION</span>
                             <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="inp-3d" class="sr-only peer">
                                <div class="w-8 h-4 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-yellow-500"></div>
                             </label>
                        </div>
                        <div id="tilt-wrapper" class="hidden transition-all border-t border-white/5 mt-2 pt-2">
                             <div class="flex justify-between text-[9px] opacity-70"><span>Tilt Angle</span><span id="lbl-tilt" class="text-yellow-500">45°</span></div>
                             <input type="range" id="inp-tilt" min="0" max="90" value="45" class="w-full mt-1 accent-yellow-500">
                        </div>
                    </div>

                    <div class="space-y-4" id="dynamic-controls">
                        <div class="space-y-1 control-group" id="grp-tau">
                            <div class="flex justify-between text-[10px]"><span class="opacity-70 font-bold">Delay (τ)</span><span id="lbl-tau" class="font-mono text-cyan-500 bg-cyan-500/10 px-1 rounded">20</span></div>
                            <input type="range" id="inp-tau" min="0" max="100" value="20">
                        </div>
                        <div class="space-y-1 control-group" id="grp-k">
                            <div class="flex justify-between text-[10px]"><span class="opacity-70 font-bold">Parameter (K/Beta)</span><span id="lbl-k" class="font-mono text-cyan-500 bg-cyan-500/10 px-1 rounded">0.1</span></div>
                            <input type="range" id="inp-k" min="0.01" max="1.0" step="0.01" value="0.1">
                        </div>
                        <div class="space-y-1 control-group">
                            <div class="flex justify-between text-[10px]"><span class="opacity-70 font-bold">Zoom</span><span id="lbl-zoom" class="font-mono text-cyan-500 bg-cyan-500/10 px-1 rounded">1.0</span></div>
                            <input type="range" id="inp-zoom" min="0.1" max="10.0" step="0.1" value="1.0">
                        </div>
                    </div>

                    <div class="glass-panel p-3 rounded-xl flex flex-col gap-2">
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center gap-2 text-[10px] opacity-70 cursor-pointer"><input type="checkbox" id="inp-ghost" checked class="accent-cyan-400"> Show Ghost</label>
                            <label class="flex items-center gap-2 text-[10px] opacity-70 cursor-pointer"><input type="checkbox" id="inp-trajectory" checked class="accent-cyan-400"> Trajectory</label>
                            <label class="flex items-center gap-2 text-[10px] opacity-70 cursor-pointer"><input type="checkbox" id="inp-glow" checked class="accent-cyan-400"> Glow</label>
                        </div>
                    </div>
                </div>

                <!-- 2. PHASE -->
                <div id="tab-phase" class="hidden h-full flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-purple-400 uppercase tracking-wider" id="phase-label">Phase Space</span>
                        <button onclick="clearPhase()" class="text-[9px] bg-white/10 px-2 py-1 rounded hover:opacity-100 opacity-60"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="flex-1 glass-panel rounded border border-purple-500/30 p-2 relative phase-grid overflow-hidden">
                        <canvas id="phaseCanvas"></canvas>
                        <div class="absolute bottom-2 right-2 text-[9px] opacity-50 font-mono">x(t) →</div>
                        <div class="absolute top-2 left-2 text-[9px] opacity-50 font-mono">v(t) / x2(t) ↑</div>
                    </div>
                    <div class="mt-2 text-[9px] font-mono flex justify-between glass-panel p-2 rounded">
                        <span>Lyapunov (Est): <span id="lyap-val" class="text-purple-400 font-bold">0.00</span></span>
                        <span class="opacity-50">Pos = Chaos</span>
                    </div>
                </div>

                <!-- 3. POINCARE MAP (NEW) -->
                <div id="tab-poincare" class="hidden h-full flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-orange-400 uppercase tracking-wider">Poincaré Map</span>
                        <button onclick="clearPoincare()" class="text-[9px] bg-white/10 px-2 py-1 rounded hover:opacity-100 opacity-60"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="flex-1 glass-panel rounded border border-orange-500/30 p-2 relative phase-grid overflow-hidden">
                        <canvas id="poincareCanvas"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center text-[9px] opacity-30 pointer-events-none">Stroboscopic View (Interval T)</div>
                    </div>
                    <div class="mt-2 text-[8px] opacity-50 text-center">
                        Samples the system state once every period (or fixed time step). Reveals fractal structure in attractors.
                    </div>
                </div>

                <!-- 4. GRAPH -->
                <div id="tab-graph" class="hidden h-full flex flex-col">
                    <div class="flex-1 glass-panel rounded p-2 relative min-h-[150px]">
                        <canvas id="graphCanvas"></canvas>
                    </div>
                    <div class="text-right mt-2"><button onclick="exportGraphPDF('graphCanvas')" class="text-[9px] bg-white/5 px-2 py-1 rounded"><i class="fas fa-camera"></i></button></div>
                </div>

                <!-- 5. BIFURCATION -->
                <div id="tab-bifurcation" class="hidden h-full flex flex-col">
                    <div class="flex justify-between items-center mb-2"><span class="text-[10px] font-bold text-green-400">Chaos Scanner</span><button onclick="runBifurcation()" class="bg-green-600 text-white text-[9px] px-2 py-1 rounded">START</button></div>
                    <div class="flex-1 glass-panel rounded border border-green-500/30 relative"><canvas id="bifCanvas" class="absolute inset-0"></canvas><div id="bif-overlay" class="hidden text-green-300 text-xs p-2">Scanning... <span id="scan-progress">0%</span></div></div>
                </div>

                <!-- 6. SPECTRUM -->
                <div id="tab-spectrum" class="hidden h-full flex flex-col">
                    <div class="flex-1 glass-panel rounded border border-pink-500/30 relative spec-grid"><canvas id="specCanvas"></canvas></div>
                </div>

                <!-- 7. DATA -->
                <div id="tab-data" class="hidden h-full flex flex-col">
                    <div class="flex justify-between mb-2"><span class="text-[10px] font-bold opacity-70">DATA</span><div class="flex gap-2"><button onclick="exportCSV()" class="bg-blue-600 text-white px-2 py-1 rounded text-[9px]">CSV</button><button onclick="exportPDF()" class="bg-red-600 text-white px-2 py-1 rounded text-[9px]">PDF</button></div></div>
                    <div class="flex-1 overflow-auto rounded glass-panel"><table class="w-full text-[9px] font-mono"><thead class="bg-slate-900 sticky top-0 text-cyan-400"><tr><th class="p-2">t</th><th>x</th><th>v</th></tr></thead><tbody id="data-body"></tbody></table></div>
                </div>
                
                <!-- 8. SERIES -->
                <div id="tab-series" class="hidden h-full flex flex-col gap-2">
                     <div class="glass-panel p-2 rounded text-center"><div id="series-eq" class="text-xs"></div></div>
                     <div class="flex justify-between items-center text-[10px]"><span class="opacity-60">Terms: <span id="lbl-terms" class="text-cyan-400">5</span></span><button class="bg-yellow-600/50 px-2 py-1 rounded text-yellow-200" onclick="toggleLimits()">Limits</button></div>
                     <input type="range" id="inp-terms" min="1" max="50" value="5">
                     <div class="flex-1 glass-panel rounded p-2 relative"><canvas id="seriesCanvas"></canvas></div>
                </div>
                
                <!-- 9. COMPARE -->
                <div id="tab-compare" class="hidden h-full flex flex-col gap-2">
                     <div class="grid grid-cols-2 gap-2 text-center text-[9px] font-bold"><div class="bg-blue-900/30 py-1 rounded text-blue-400">NEWTON</div><div class="bg-pink-900/30 py-1 rounded text-pink-400">RAJU</div></div>
                     <div class="flex-1 glass-panel rounded p-2 relative"><canvas id="compareCanvas"></canvas></div>
                     <div class="glass-panel p-2 rounded text-[9px] font-mono"><div class="flex justify-between"><span>Err PDE:</span> <span id="drift-pde" class="text-blue-400">0%</span></div><div class="flex justify-between"><span>Err FDE:</span> <span id="drift-fde" class="text-pink-400">0%</span></div></div>
                </div>

                <!-- 10. GUIDE -->
                <div id="tab-info" class="hidden h-full glass-panel p-4 rounded-xl overflow-y-auto prose-sci">
                    <h2 id="info-title" class="text-lg font-bold mb-2"></h2>
                    <div id="info-content" class="text-xs opacity-80"></div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- SERVICE WORKER REGISTRATION (PWA) -->
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(reg => console.log('SW Registered')).catch(err => console.log('SW Fail', err));
}
</script>

<script>
/**
 * RAJU'S FDE LAB: SCIENTIFIC UNIVERSE V11
 * Features: 3D Phase Space, PWA Fixes, Canvas Auto-Resize
 */

const ALGO_DB = {
    'SANDBOX': [
        { id: 'custom_eq', title: 'Custom Playground (2D)', type: 'CUSTOM', eq: '\\dot{x}=f_1(...), \\dot{v}=f_2(...)', presets: [{name:'Oscillator', dx:'return v', dv:'return -k*x'}, {name:'Damped', dx:'return v', dv:'return -k*x - 0.1*v'}], usage: 'Define dx/dt and dv/dt. Vars: x, v, t, k, tau, x_old, v_old.', science: 'Full sandbox for coupled differential equations.' }
    ],
    'CHAOS (ADVANCED)': [
        { id: 'double_pendulum', title: 'Double Pendulum', type: 'PENDULUM_2', eq: '\\ddot{\\theta}_1, \\ddot{\\theta}_2 = f(\\theta, \\dot{\\theta})', presets: [{name:'Chaotic', k:1, tau:0}], usage: 'Classic chaos. Low K = Low Energy.', science: 'Two coupled pendulums. Extremely sensitive to initial conditions.' },
        { id: 'rossler_attractor', title: 'Rössler Attractor', type: 'ROSSLER', eq: '\\dot{x}=-y-z, \\dot{y}=x+ay, \\dot{z}=b+z(x-c)', presets: [{name:'Chaos', k:0.2}], usage: 'Simpler than Lorenz. Check Poincaré map.', science: 'Topology of chaos.' },
        { id: 'lorenz_attractor', title: 'Lorenz Attractor', type: 'LORENZ', eq: '\\dot{x}=\\sigma(y-x)...', presets: [{name:'Butterfly', k:10}], usage: 'Rotate in 3D.', science: 'The classic strange attractor.' }
    ],
    'NEUROSCIENCE': [
        { id: 'fitzhugh_nagumo', title: 'FitzHugh-Nagumo', type: 'NEURON', eq: '\\dot{v} = v - v^3/3 - w + I', presets: [{name:'Spiking', k:0.5}, {name:'Resting', k:0}], usage: 'K = Input Current. V=Voltage, W=Recovery.', science: 'Simplified model of neuronal spiking dynamics.' }
    ],
    'BIO-CHEMISTRY': [
        { id: 'gray_scott', title: 'Gray-Scott Patterns', type: 'REACTION_DIFFUSION', eq: '\\partial u/\\partial t = D_u \\nabla^2 u - uv^2...', presets: [{name:'Mitosis', k:0.062, tau:0.037}], usage: 'Wait for patterns. Touch to seed.', science: 'Turing patterns simulating skin spots.' },
        { id: 'lotka_volterra', title: 'Predator-Prey', type: 'COUPLED_LV', eq: '\\dot{x}=x(\\alpha-\\beta y), \\dot{y}=y(\\delta x-\\gamma)', presets: [{name:'Cycle', k:0.5}], usage: 'X=Prey, Y=Predator.', science: 'Population dynamics.' },
        { id: 'sir_model', title: 'SIR Epidemic', type: 'SIR', eq: '\\dot{S}=-\\beta SI', presets: [{name:'Outbreak', k:0.5}], usage: 'S=Blue, I=Red.', science: 'Infectious disease modeling.' }
    ],
    'CLASSICAL MECHANICS': [
        { id: 'osc_compare', title: 'Newton vs FDE', type: 'COMPARE', eq: 'm\\ddot{x} = -kx(t-\\tau)', presets: [{name:'Stable', k:0.1, tau:5}], usage: 'Compare Energy drift.', science: 'Delay causes non-conservation.' },
        { id: 'ret_grav', title: 'Retarded Gravity', type: 'FDE', eq: 'a \\propto 1/r(t-\\tau)^2', presets: [{name:'Precession', k:0.1, tau:15}], usage: 'Watch orbital shifts.', science: 'Finite speed of gravity torque.' },
        { id: 'pendulum_damped', title: 'Damped Pendulum', type: 'FDE', eq: '\\ddot{\\theta} + \\gamma\\dot{\\theta} + g/L\\sin(\\theta) = 0', presets: [{name:'Simple', k:0.1}], usage: 'Nonlinear oscillator.', science: 'Small angle approx breakdown.' }
    ],
    'CIRCUITS': [
        { id: 'rlc_circuit', title: 'RLC Circuit', type: 'FDE', eq: 'L\\ddot{q} + R\\dot{q} + q/C = V(t)', presets: [{name:'Ring', k:0.1}], usage: 'Oscillating charge.', science: 'Electrical resonance.' },
        { id: 'van_der_pol', title: 'Van der Pol', type: 'FDE', eq: '\\ddot{x} - \\mu(1-x^2)\\dot{x} + x = 0', presets: [{name:'Relaxation', k:1.0}], usage: 'Limit cycles.', science: 'Vacuum tubes model.' }
    ],
    'FOUNDATIONS': [
        { id: 'series_sin', title: 'Infinite Series', type: 'SERIES', eq: '\\sin(x) \\approx \\sum ...', presets: [{name:'Low N', terms:2}], usage: 'Slide Terms.', science: 'Madhava series.' },
        { id: 'timeline', title: 'History of Time', type: 'TIMELINE', eq: '\\Delta t \\to dt', presets: [], usage: 'Drag slider.', science: 'Calculus evolution.' }
    ],
    'FIELDS': [
        { id: 'em_ret', title: 'Retarded Potentials', type: 'EM_PARTICLE', eq: 'E \\propto q(t-\\tau)/R^2', presets: [{name:'Field', tau:20}], usage: 'Moving charge.', science: 'Liénard–Wiechert potentials.' },
        { id: 'thermo_hyp', title: 'Hyperbolic Heat', type: 'THERMO_1D', eq: '\\tau T_{tt} + T_t = \\alpha T_{xx}', presets: [{name:'Wave', tau:80}], usage: 'Touch to heat.', science: 'Second Sound.' }
    ]
};

const State = {
    activeAlgo: null, running: false, t: 0,
    history: { x: [], v: [], x2: [], v2: [], z: [], x_pde: [], v_pde: [] },
    field: [], grid: [], gridV: [], particles: [],
    gs: { u: [], v: [], w: 100, h: 100 },
    params: { k: 0.1, gamma: 0.05, tau: 20, zoom: 1.0, terms: 5, showLimits: false, color: '#06b6d4', glow: true, showTrajectory: true, showGhost: true, is3D: false, tilt: 45 },
    audio: { ctx: null, analyser: null, source: null, gain: null, enabled: false },
    rec: { recorder: null, stream: null, chunks: [], recording: false },
    customFn: { dx: null, dv: null },
    lyapunov: 0, theme: 'dark', cinema: false
};

const cvs=document.getElementById('simCanvas'), ctx=cvs.getContext('2d');
const phaseCvs=document.getElementById('phaseCanvas'), phaseCtx=phaseCvs.getContext('2d');
const poinCvs=document.getElementById('poincareCanvas'), poinCtx=poinCvs.getContext('2d');
const bifCvs=document.getElementById('bifCanvas'), specCvs=document.getElementById('specCanvas');
let chartObj=null, seriesChart=null, compareChart=null;

function init() {
    resize(); populateHome(); window.addEventListener('resize', resize);
    ['tau','k','zoom','terms','tilt'].forEach(p => bindInput(`inp-${p}`, p));
    document.getElementById('inp-ghost').addEventListener('change', e=>State.params.showGhost=e.target.checked);
    document.getElementById('inp-3d').addEventListener('change', e=>{ State.params.is3D=e.target.checked; document.getElementById('tilt-wrapper').classList.toggle('hidden',!e.target.checked); });
    document.getElementById('timeline-slider').addEventListener('input', updateTimeline);
    setupInteractions(); requestAnimationFrame(loop);
}

function launchSim(algo) {
    State.activeAlgo = algo; State.t = 0; State.running = true; State.lyapunov = 0;
    State.history = { x: [1], v: [0], x2: [0.5], v2: [0], z: [1], x_pde: [1], v_pde: [0] };
    if(algo.type.includes('PENDULUM_2')) { State.history.x=[Math.PI/2]; State.history.x2=[Math.PI/2]; State.history.v=[0]; State.history.v2=[0]; }
    if(algo.type==='FDE_1ST'||algo.type==='LORENZ'||algo.type==='ROSSLER') State.history.x=[0.1];
    if(algo.type==='LORENZ'||algo.type==='ROSSLER') { State.history.x2=[0]; State.history.z=[0]; }
    if(algo.type==='NEURON') { State.history.x=[-1]; State.history.v=[0]; }
    
    clearPhase(); clearPoincare();
    if(chartObj)chartObj.destroy(); if(seriesChart)seriesChart.destroy(); if(compareChart)compareChart.destroy(); chartObj=null; seriesChart=null; compareChart=null;
    document.getElementById('sim-title').innerText = algo.title.toUpperCase();
    document.getElementById('sim-status').innerText = 'RUNNING';
    document.getElementById('info-title').innerText = algo.title;
    document.getElementById('info-content').innerHTML = `<div class="mb-4 glass-panel p-3 rounded shadow-inner"><div class="text-[9px] opacity-60 font-bold mb-1">Model</div><div id="info-eq-render" class="text-cyan-500 text-sm overflow-x-auto"></div></div>${algo.usage}<hr class="border-white/10 my-4">${algo.science}`;
    setTimeout(() => { try{katex.render(algo.eq, document.getElementById('info-eq-render'), {throwOnError:false})}catch(e){} }, 100);

    const isCustom = algo.type === 'CUSTOM';
    document.getElementById('custom-eq-panel').classList.toggle('hidden', !isCustom);
    if(isCustom) applyCustomEq();

    const pc = document.getElementById('preset-container'); pc.innerHTML='';
    (algo.presets||[]).forEach(p=>{
        const b=document.createElement('button'); b.className='text-[9px] bg-white/10 hover:bg-cyan-500/20 hover:text-cyan-500 border border-white/10 px-2 py-1 rounded transition';
        b.innerText=p.name; b.onclick=()=>applyPreset(p); pc.appendChild(b);
    });

    if(algo.type.includes('FIELD')||algo.type.includes('THERMO')||algo.type.includes('WAVE')) initGrid();
    if(algo.type==='REACTION_DIFFUSION') initGrayScott();
    if(algo.type==='EM_PARTICLE') initParticles();

    ['tab-btn-series','tab-btn-compare'].forEach(id=>document.getElementById(id).classList.add('hidden'));
    document.getElementById('timeline-ui').classList.add('hidden');
    let def='controls';
    if(algo.type==='SERIES') { document.getElementById('tab-btn-series').classList.remove('hidden'); def='series'; initSeriesChart(); updateCharts(); }
    else if(algo.type==='TIMELINE') document.getElementById('timeline-ui').classList.remove('hidden');
    else if(algo.type.includes('COMPARE')||algo.type.includes('FIELD_COMPARE')) { document.getElementById('tab-btn-compare').classList.remove('hidden'); def='compare'; initCompareChart(); }
    else initChart();
    
    setTab(def); renderMath();
    document.getElementById('view-home').style.transform = 'translateX(-100%)';
    document.getElementById('view-sim').style.transform = 'translateX(0)';
}

function goBack() { State.running=false; document.getElementById('view-home').style.transform='translateX(0)'; document.getElementById('view-sim').style.transform='translateX(100%)'; }

function loop() {
    if(!State.running || !State.activeAlgo) { requestAnimationFrame(loop); return; }
    const dt = 0.1; const type = State.activeAlgo.type;

    try {
        if(type==='FDE'||type==='COMPARE') physicsFDE(dt);
        else if(type==='CUSTOM') physicsCustom(dt);
        else if(type==='PENDULUM_2') physicsDoublePendulum(dt);
        else if(type==='ROSSLER') physicsRossler(dt);
        else if(type==='NEURON') physicsFitzHugh(dt);
        else if(type==='FDE_1ST') physicsMackey(dt);
        else if(type==='COUPLED'||type.includes('COUPLED_')) physicsCoupled(dt);
        else if(type==='LORENZ') physicsLorenz(dt);
        else if(type==='SIR') physicsSIR(dt);
        else if(type==='REACTION_DIFFUSION') physicsGrayScott();
        else if(type.includes('FIELD')||type.includes('WAVE')||type.includes('THERMO')) gridStep(dt);
        else if(type==='EM_PARTICLE') emStep(dt);
    } catch(e) { console.error(e); }
    
    State.t++;
    if(State.t%10===0 && State.history.x.length>20) {
        let d = Math.abs(State.history.x[0]-State.history.x[20]);
        if(d>0) State.lyapunov = Math.log(d/0.001)/20;
        document.getElementById('lyap-val').innerText = State.lyapunov.toFixed(3);
    }

    if(type!=='TIMELINE') { 
        if(type==='REACTION_DIFFUSION') drawGrayScott();
        else { drawWorld(); drawPhaseSpace(); drawPoincare(); }
        if(!document.getElementById('tab-spectrum').classList.contains('hidden')) drawSpectrum();
    }
    
    let audioVal = State.history.x[0] || (State.grid.length>50?State.grid[50]:0);
    updateAudio(audioVal);
    if(State.t%3===0) { updateTable(); updateCharts(); }
    requestAnimationFrame(loop);
}

function getDelayed(arr, tau) { let i=Math.floor(tau); if(i>=arr.length)i=arr.length-1; return arr[i<0?0:i]; }

function physicsFDE(dt) {
    let k=State.params.k, x=State.history.x[0], v=State.history.v[0], x_old=getDelayed(State.history.x, State.params.tau);
    let a = -k*x_old - 0.05*v;
    if(State.activeAlgo.id==='ret_grav') a = -10*k/Math.pow(Math.max(0.5,Math.abs(x_old)),2) + v*v/Math.max(0.5,Math.abs(x));
    else if(State.activeAlgo.id==='proj_drag') a = -k*x - 0.05*v - 0.1*getDelayed(State.history.v, State.params.tau);
    else if(State.activeAlgo.id==='rlc_circuit') a = -k*v - x + Math.sin(State.t*0.1); 
    else if(State.activeAlgo.id==='van_der_pol') a = k*(1-x*x)*v - x; 
    else if(State.activeAlgo.id==='pendulum_damped') a = -0.05*v - k*Math.sin(x_old);
    
    v+=a*dt; x+=v*dt;
    State.history.x.unshift(x); State.history.v.unshift(v);
    if(State.activeAlgo.type==='COMPARE') {
        let xp=State.history.x_pde[0], vp=State.history.v_pde[0];
        vp += (-k*xp - 0.05*vp)*dt; xp += vp*dt;
        State.history.x_pde.unshift(xp); State.history.v_pde.unshift(vp);
    }
    trimHist();
}

function physicsCustom(dt) {
    if(!State.customFn.dx) return;
    let x=State.history.x[0], v=State.history.v[0], x_old=getDelayed(State.history.x, State.params.tau), v_old=getDelayed(State.history.v, State.params.tau);
    let dx=0, dv=0;
    try { 
        dx = State.customFn.dx(x, v, State.t, State.params.k, State.params.tau, x_old, v_old);
        dv = State.customFn.dv(x, v, State.t, State.params.k, State.params.tau, x_old, v_old);
    } catch(e) { dx=0; dv=0; }
    x+=dx*dt; v+=dv*dt;
    State.history.x.unshift(x); State.history.v.unshift(v); trimHist();
}

function physicsDoublePendulum(dt) {
    let t1=State.history.x[0], w1=State.history.v[0], t2=State.history.x2[0], w2=State.history.v2[0];
    let g=1, m1=1, m2=1, L1=1, L2=1;
    let num1 = -g*(2*m1+m2)*Math.sin(t1) - m2*g*Math.sin(t1-2*t2) - 2*Math.sin(t1-t2)*m2*(w2*w2*L2 + w1*w1*L1*Math.cos(t1-t2));
    let den1 = L1*(2*m1+m2-m2*Math.cos(2*t1-2*t2));
    let num2 = 2*Math.sin(t1-t2)*(w1*w1*L1*(m1+m2) + g*(m1+m2)*Math.cos(t1) + w2*w2*L2*m2*Math.cos(t1-t2));
    let den2 = L2*(2*m1+m2-m2*Math.cos(2*t1-2*t2));
    let a1 = num1/den1; let a2 = num2/den2;
    w1+=a1*dt; t1+=w1*dt; w2+=a2*dt; t2+=w2*dt;
    State.history.x.unshift(t1); State.history.v.unshift(w1);
    State.history.x2.unshift(t2); State.history.v2.unshift(w2); trimHist();
}

function physicsFitzHugh(dt) {
    let v=State.history.x[0], w=State.history.v[0], I=State.params.k; 
    let dv = v - (v*v*v)/3 - w + I;
    let dw = 0.08 * (v + 0.7 - 0.8*w);
    State.history.x.unshift(v+dv*dt); State.history.v.unshift(w+dw*dt); trimHist();
}

function physicsRossler(dt) {
    let x=State.history.x[0], y=State.history.x2[0], z=State.history.z[0], a=0.2, b=0.2, c=5.7;
    let dx = (-y-z)*dt*0.5, dy = (x+a*y)*dt*0.5, dz = (b + z*(x-c))*dt*0.5;
    State.history.x.unshift(x+dx); State.history.x2.unshift(y+dy); State.history.z.unshift(z+dz); State.history.v.unshift(dx); trimHist();
}

function physicsMackey(dt){let x=State.history.x[0],xt=getDelayed(State.history.x,State.params.tau);let dx=(State.params.k*2*xt)/(1+Math.pow(xt,10))-0.1*x;State.history.x.unshift(x+dx*dt);State.history.v.unshift(dx);trimHist()}
function physicsCoupled(dt){if(State.activeAlgo.type==='COUPLED_LV'){physicsLotka(dt);return;}if(State.activeAlgo.type==='COUPLED_BRUSS'){physicsBruss(dt);return;}let k=State.params.k,t=State.params.tau,x1=State.history.x[0],v1=State.history.v[0],x2=State.history.x2[0],v2=State.history.v2[0];let x1t=getDelayed(State.history.x,t),x2t=getDelayed(State.history.x2,t);v1+=(-x1+k*(x2t-x1)-0.05*v1)*dt;x1+=v1*dt;v2+=(-x2+k*(x1t-x2)-0.05*v2)*dt;x2+=v2*dt;State.history.x.unshift(x1);State.history.v.unshift(v1);State.history.x2.unshift(x2);State.history.v2.unshift(v2);trimHist()}
function physicsLotka(dt){let x=State.history.x[0],y=State.history.x2[0];let dx=(0.1*x-State.params.k*x*y)*dt,dy=(State.params.k*x*y-0.2*y)*dt;State.history.x.unshift(x+dx);State.history.x2.unshift(y+dy);State.history.v.unshift(dx);trimHist()}
function physicsBruss(dt){let x=State.history.x[0],y=State.history.x2[0],A=1,B=State.params.k*10;let dx=(A+x*x*y-B*x-x)*dt,dy=(B*x-x*x*y)*dt;State.history.x.unshift(x+dx);State.history.x2.unshift(y+dy);State.history.v.unshift(dx);trimHist()}
function physicsLorenz(dt){let x=State.history.x[0],y=State.history.x2[0],z=State.history.z[0],s=10,r=State.params.k*50,b=8/3;let dx=s*(y-x)*dt*0.1,dy=(x*(r-z)-y)*dt*0.1,dz=(x*y-b*z)*dt*0.1;State.history.x.unshift(x+dx);State.history.x2.unshift(y+dy);State.history.z.unshift(z+dz);State.history.v.unshift(dx);trimHist()}
function physicsSIR(dt){let s=State.history.x[0],i=State.history.x2[0],r=State.history.z[0]||0,b=State.params.k,g=0.1;let ds=-b*s*i*dt,di=(b*s*i-g*i)*dt,dr=g*i*dt;State.history.x.unshift(s+ds);State.history.x2.unshift(i+di);State.history.z.unshift(r+dr);State.history.v.unshift(ds);trimHist()}
function trimHist(){if(State.history.x.length>2000)Object.values(State.history).forEach(a=>a.length>2000&&a.pop())}

function initGrayScott() {
    let sz = 64; State.gs = { u: new Float32Array(sz*sz).fill(1), v: new Float32Array(sz*sz).fill(0), size: sz };
    for(let y=28;y<36;y++)for(let x=28;x<36;x++) State.gs.v[y*sz+x] = 1;
}
function physicsGrayScott() {
    let { u, v, size } = State.gs;
    let nextU = new Float32Array(u), nextV = new Float32Array(v);
    let Du=0.2, Dv=0.1, f=0.01+State.params.k*0.08, k=0.03+State.params.tau*0.001; 
    for(let y=1; y<size-1; y++){
        for(let x=1; x<size-1; x++){
            let i = y*size + x;
            let lapU = (u[i-1]+u[i+1]+u[i-size]+u[i+size] - 4*u[i]);
            let lapV = (v[i-1]+v[i+1]+v[i-size]+v[i+size] - 4*v[i]);
            let uvv = u[i]*v[i]*v[i];
            nextU[i] = u[i] + (Du*lapU - uvv + f*(1-u[i]));
            nextV[i] = v[i] + (Dv*lapV + uvv - (f+k)*v[i]);
        }
    }
    State.gs.u = nextU; State.gs.v = nextV;
}
function drawGrayScott() {
    let { u, v, size } = State.gs;
    let id = ctx.createImageData(size, size);
    for(let i=0; i<u.length; i++){
        let val = Math.floor((u[i]-v[i])*255); val = Math.max(0, Math.min(255, val));
        let idx = i*4; id.data[idx] = val; id.data[idx+1] = val>100?255:0; id.data[idx+2] = 255-val; id.data[idx+3] = 255;
    }
    ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--bg-color'); ctx.fillRect(0,0,cvs.width,cvs.height);
    let tempCvs = document.createElement('canvas'); tempCvs.width=size; tempCvs.height=size;
    tempCvs.getContext('2d').putImageData(id,0,0);
    ctx.imageSmoothingEnabled = false; ctx.drawImage(tempCvs, 0, 0, cvs.width, cvs.height);
}

function initGrid(){State.grid=new Array(100).fill(0);State.gridV=new Array(100).fill(0);State.field=new Array(100).fill(0).map((_,i)=>({r:Math.exp(-Math.pow((i-50)/5,2)),i:0}));for(let i=45;i<55;i++)State.grid[i]=Math.sin((i-45)/10*Math.PI)}
function gridStep(dt){let g=State.grid,gv=State.gridV,ng=[...g],ngv=[...gv];let isThermo=State.activeAlgo.type.includes('THERMO');let inertia=isThermo?State.params.tau*0.02:1.0;for(let i=1;i<99;i++){let acc=(0.5*(g[i-1]+g[i+1]-2*g[i])-(isThermo?0:0.01)*gv[i])/(inertia+0.1);ngv[i]+=acc*dt;ng[i]+=ngv[i]*dt}State.grid=ng;State.gridV=ngv}
function fieldStep(dt){let f=State.field,nf=new Array(f.length);nf[0]=nf[f.length-1]={r:0,i:0};for(let i=1;i<f.length-1;i++){let lr=f[i-1].r+f[i+1].r-2*f[i].r,li=f[i-1].i+f[i+1].i-2*f[i].i;let V=0.01*Math.pow(i-50,2)+State.params.k*(Math.pow(f[i].r,2)+Math.pow(f[i].i,2));nf[i]={r:f[i].r+(-0.5*li+V*f[i].i)*dt,i:f[i].i-(-0.5*lr+V*f[i].r)*dt}}State.field=nf}
function initParticles(){State.particles=[{x:0,y:0,vx:0,vy:0,fixed:true},{x:100,y:50,vx:0,vy:2,fixed:false}]}
function emStep(dt){let p=State.particles,tau=State.params.tau;p[0].y=50*Math.sin(State.t*0.05);let retY=50*Math.sin((State.t-tau)*0.05);let dx=p[1].x-p[0].x,dy=p[1].y-retY,dist=Math.sqrt(dx*dx+dy*dy+10);let F=1000/(dist*dist);if(!p[1].fixed){p[1].vx-=F*(dx/dist)*dt;p[1].vy-=F*(dy/dist)*dt;p[1].x+=p[1].vx*dt;p[1].y+=p[1].vy*dt}}

function drawWorld() {
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg-color'); ctx.fillRect(0,0,cvs.width,cvs.height);
    const cx=cvs.width/2, cy=cvs.height/2, zoom=State.params.zoom;
    ctx.save(); ctx.translate(cx, cy); ctx.scale(zoom, zoom);
    
    function project(x,y,z) {
        if(!State.params.is3D) return {x,y};
        const rad = State.params.tilt*Math.PI/180;
        let yr = y*Math.cos(rad) - z*Math.sin(rad);
        let zr = y*Math.sin(rad) + z*Math.cos(rad);
        let s = 500/(500+zr); return {x:x*s, y:yr*s};
    }

    if(State.params.is3D || State.activeAlgo.type==='LORENZ'||State.activeAlgo.type==='ROSSLER') {
        ctx.strokeStyle = State.theme==='light' ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.05)'; 
        ctx.lineWidth=1/zoom; ctx.beginPath();
        for(let i=-200;i<=200;i+=50) {
            let p1=project(i,0,-200), p2=project(i,0,200), p3=project(-200,0,i), p4=project(200,0,i);
            ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); ctx.moveTo(p3.x,p3.y); ctx.lineTo(p4.x,p4.y);
        }
        ctx.stroke();
    }

    ctx.strokeStyle = State.params.color; ctx.lineWidth = 2/zoom;

    if(State.activeAlgo.type==='PENDULUM_2') {
        let t1=State.history.x[0], t2=State.history.x2[0];
        let x1=100*Math.sin(t1), y1=100*Math.cos(t1);
        let x2=x1+100*Math.sin(t2), y2=y1+100*Math.cos(t2);
        ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
        ctx.fillStyle=State.params.color; ctx.beginPath(); ctx.arc(x1,y1,5,0,6.28); ctx.fill(); ctx.beginPath(); ctx.arc(x2,y2,5,0,6.28); ctx.fill();
        ctx.strokeStyle='rgba(255,255,255,0.2)'; ctx.beginPath();
        State.history.x2.slice(0,500).forEach((val, i)=>{
            let tx1=100*Math.sin(State.history.x[i]), ty1=100*Math.cos(State.history.x[i]);
            let tx2=tx1+100*Math.sin(val), ty2=ty1+100*Math.cos(val);
            i===0?ctx.moveTo(tx2,ty2):ctx.lineTo(tx2,ty2);
        });
        ctx.stroke();
    }
    else if(State.activeAlgo.type==='LORENZ'||State.activeAlgo.type==='ROSSLER') {
        ctx.beginPath();
        State.history.x.slice(0,1000).forEach((x,i)=>{
            let y=State.history.x2[i], z=State.history.z[i];
            let p = project(x*5, y*5, z*5 - 100);
            i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y);
        });
        ctx.stroke();
    }
    else if(State.activeAlgo.type.includes('COUPLED') || State.activeAlgo.type==='SIR') {
        [State.history.x, State.history.x2, State.history.z].forEach((hist, idx) => {
            if(!hist || hist.length===0) return;
            ctx.strokeStyle = idx===0 ? '#06b6d4' : (idx===1 ? '#e879f9' : '#4ade80');
            ctx.beginPath();
            hist.slice(0,500).forEach((v,i) => {
                let p = project(i*-2, v*50 + (idx-1)*50, 0); 
                i===0 ? ctx.moveTo(p.x,p.y) : ctx.lineTo(p.x,p.y);
            });
            ctx.stroke();
        });
    }
    else if(State.history.x.length > 0) {
        ctx.beginPath();
        State.history.x.slice(0, 1000).forEach((v,i) => {
            let p = State.activeAlgo.id==='ret_grav' 
                ? project(v*Math.cos((State.t-i)*.05)*20, v*Math.sin((State.t-i)*.05)*20, i)
                : project(State.params.is3D?0:i*-2, v*50, State.params.is3D?i*2:0);
            i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y);
        });
        ctx.stroke();
        if(State.params.showGhost && State.params.tau > 0) {
            let idx = Math.floor(State.params.tau); let gv = State.history.x[idx]||0;
            let gp = project(State.params.is3D?0:-idx*2, gv*50, State.params.is3D?idx*2:0);
            if(State.activeAlgo.id==='ret_grav') gp = project(gv*Math.cos((State.t-State.params.tau)*.05)*20, gv*Math.sin((State.t-State.params.tau)*.05)*20, 0);
            ctx.fillStyle=State.theme==='light'?'rgba(0,0,0,0.3)':'rgba(255,255,255,0.3)'; ctx.beginPath(); ctx.arc(gp.x,gp.y,4/zoom,0,6.28); ctx.fill();
        }
    }
    
    if(State.activeAlgo.type.includes('FIELD') || State.activeAlgo.type.includes('WAVE')) {
        let arr = State.activeAlgo.type.includes('FIELD') ? State.field.map(f=>Math.sqrt(Math.pow(f.r,2)+Math.pow(f.i,2))) : State.grid;
        ctx.beginPath(); arr.forEach((v,i) => { let p = project((i-50)*5, v*50, 0); i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y); }); ctx.stroke();
    }
    ctx.restore();
}

function drawPhaseSpace() {
    if(document.getElementById('tab-phase').classList.contains('hidden')) return;
    phaseCtx.fillStyle = State.theme==='light'?'rgba(255,255,255,0.1)':'rgba(0,0,0,0.05)'; phaseCtx.fillRect(0,0,phaseCvs.width, phaseCvs.height);
    const cx=phaseCvs.width/2, cy=phaseCvs.height/2, scale=40;
    
    // 3D Rotation for Phase Space too!
    const rad = State.params.is3D ? State.params.tilt*Math.PI/180 : 0;
    function proj(x, y, z=0) {
        if(!State.params.is3D) return {x,y};
        let yr = y*Math.cos(rad) - z*Math.sin(rad);
        let zr = y*Math.sin(rad) + z*Math.cos(rad);
        let s = 500/(500+zr); return {x:x*s, y:yr*s};
    }

    let x=State.history.x[0], y=State.history.v[0], z=0, xp=State.history.x[1], yp=State.history.v[1], zp=0;
    if(State.activeAlgo.type.includes('COUPLED')||State.activeAlgo.type==='LORENZ'||State.activeAlgo.type==='SIR') { y = State.history.x2[0]; yp = State.history.x2[1]; }
    if(State.activeAlgo.type==='LORENZ') { z = State.history.z[0]; zp = State.history.z[1]; }

    let p1 = proj(x*scale, y*scale, z*scale);
    let p2 = proj(xp*scale, yp*scale, zp*scale);
    
    phaseCtx.save(); phaseCtx.translate(cx, cy);
    phaseCtx.strokeStyle = '#a855f7'; phaseCtx.lineWidth=2;
    phaseCtx.beginPath(); phaseCtx.moveTo(p2.x, -p2.y); phaseCtx.lineTo(p1.x, -p1.y); phaseCtx.stroke();
    phaseCtx.restore();
}

function drawPoincare() {
    if(document.getElementById('tab-poincare').classList.contains('hidden')) return;
    if(State.t % 20 === 0) { 
        poinCtx.fillStyle = '#f97316';
        let x = State.history.x[0], y = State.history.v[0];
        if(State.activeAlgo.type==='LORENZ') { y = State.history.z[0]; }
        let cx = poinCvs.width/2 + x*30;
        let cy = poinCvs.height/2 - y*30;
        poinCtx.fillRect(cx, cy, 2, 2);
    }
}

function applyCustomEq() {
    const dxCode = document.getElementById('inp-custom-dx').value;
    const dvCode = document.getElementById('inp-custom-dv').value;
    try {
        State.customFn = {
            dx: new Function('x', 'v', 't', 'k', 'tau', 'x_old', 'v_old', dxCode),
            dv: new Function('x', 'v', 't', 'k', 'tau', 'x_old', 'v_old', dvCode)
        };
        showToast("Custom Model Compiled");
    } catch(e) { showToast("Syntax Error in Equation"); }
}

function toggleTheme() { State.theme = State.theme==='dark' ? 'light' : 'dark'; document.body.className = State.theme==='light' ? 'theme-light' : ''; }
function toggleCinema() { State.cinema = !State.cinema; document.getElementById('ui-layer').classList.toggle('cinema-hidden', State.cinema); showToast(State.cinema ? "Cinema Mode ON (Click to Exit)" : "Cinema Mode OFF"); if(State.cinema) cvs.addEventListener('click', toggleCinema, {once:true}); }
function toggleRecording() {
    if(!State.rec.recording) {
        try {
            State.rec.stream = cvs.captureStream(30);
            State.rec.recorder = new MediaRecorder(State.rec.stream, { mimeType: 'video/webm' });
            State.rec.recorder.ondataavailable = e => State.rec.chunks.push(e.data);
            State.rec.recorder.onstop = e => {
                const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(State.rec.chunks, { type: 'video/webm' })); a.download = 'sim.webm'; a.click(); State.rec.chunks = [];
            };
            State.rec.recorder.start(); State.rec.recording = true;
            document.getElementById('rec-status').classList.remove('hidden'); document.getElementById('btn-rec').classList.add('animate-pulse'); showToast("Recording...");
        } catch(e) { showToast("Recording Not Supported"); }
    } else {
        State.rec.recorder.stop(); State.rec.recording = false;
        document.getElementById('rec-status').classList.add('hidden'); document.getElementById('btn-rec').classList.remove('animate-pulse'); showToast("Video Saved");
    }
}

function resize(){
    cvs.width=window.innerWidth; cvs.height=window.innerHeight; 
    // CRITICAL FIX: Only resize if element is visible to prevent 0x0 errors
    [phaseCvs, bifCvs, specCvs, poinCvs].forEach(c => { 
        if(c && c.offsetParent !== null) { 
            c.width = c.clientWidth; c.height = c.clientHeight; 
        } 
    });
}
function bindInput(id,p){document.getElementById(id).addEventListener('input',e=>{State.params[p]=parseFloat(e.target.value);document.getElementById(`lbl-${p}`).innerText=e.target.value;renderMath()})}
function renderMath(){if(State.activeAlgo){let eq=State.activeAlgo.eq.replace(/k/g,State.params.k).replace(/\\tau/g,State.params.tau);try{katex.render(eq,document.getElementById('katex-eq'),{throwOnError:false})}catch(e){}}}
function applyPreset(p){
    if(p.dx) { document.getElementById('inp-custom-dx').value=p.dx; document.getElementById('inp-custom-dv').value=p.dv; applyCustomEq(); }
    Object.keys(p).forEach(k=>{if(!['name','dx','dv'].includes(k)){State.params[k]=p[k];let el=document.getElementById(`inp-${k}`);if(el)el.value=p[k]}}); 
    if(State.activeAlgo.type==='FDE_1ST'||State.activeAlgo.type==='LORENZ')State.history.x=[0.1];else State.history.x=[1]; 
    clearPhase(); clearPoincare(); showToast(`Preset: ${p.name}`); renderMath();
}
function clearPhase(){phaseCvs.width=phaseCvs.clientWidth;phaseCvs.height=phaseCvs.clientHeight;phaseCtx.clearRect(0,0,phaseCvs.width,phaseCvs.height)}
function clearPoincare(){poinCvs.width=poinCvs.clientWidth;poinCvs.height=poinCvs.clientHeight;poinCtx.clearRect(0,0,poinCvs.width,poinCvs.height)}
function updateTable(){const b=document.getElementById('data-body'); if(document.getElementById('tab-data').classList.contains('hidden'))return;let v=State.history.x[0]||0,d=State.history.v[0]||0;let r=document.createElement('tr');r.innerHTML=`<td class="p-2 border-b border-white/5 text-slate-500">${State.t}</td><td class="p-2 border-b border-white/5 text-cyan-400">${v.toFixed(3)}</td><td class="p-2 border-b border-white/5 text-pink-400">${d.toFixed(3)}</td>`;b.insertBefore(r,b.firstChild);if(b.children.length>20)b.removeChild(b.lastChild);}
function setTab(name){
    document.querySelectorAll('.tab-btn').forEach(b=>{b.classList.remove('text-cyan-400','border-cyan-400','opacity-100');b.classList.add('opacity-60','border-transparent')});
    const btn=document.querySelector(`button[onclick="setTab('${name}')"]`);
    if(btn){btn.classList.remove('opacity-60','border-transparent');btn.classList.add('text-cyan-400','border-cyan-400','opacity-100')}
    ['controls','phase','poincare','graph','bifurcation','spectrum','data','series','compare','info'].forEach(t=>document.getElementById(`tab-${t}`).classList.add('hidden'));
    document.getElementById(`tab-${name}`).classList.remove('hidden');
    // FORCE RESIZE on tab switch to fix 0-width bugs
    setTimeout(resize, 50); 
}
function toggleDrawer(){const d=document.getElementById('drawer');d.style.transform=d.style.transform==='translateY(70%)'?'translateY(0)':'translateY(70%)'}
function toggleFocusMode(){const d=document.getElementById('drawer'),h=document.getElementById('sim-header');d.classList.toggle('focus-hide');h.classList.toggle('header-hide')}
function togglePause(){State.running=!State.running;document.getElementById('play-btn').innerHTML=State.running?'<i class="fas fa-pause text-xs"></i>':'<i class="fas fa-play text-xs"></i>';document.getElementById('sim-status').innerText=State.running?'RUNNING':'PAUSED';if(State.running)loop()}
function showToast(msg){const t=document.getElementById('toast');document.getElementById('toast-msg').innerText=msg;t.style.opacity='1';setTimeout(()=>t.style.opacity='0',2000)}
function updateTimeline(){const m=["476 CE: Aryabhata","1400 CE: Madhava","1687 CE: Newton","1977: Chaos","FUTURE: Raju"];document.getElementById('timeline-info').innerText=m[document.getElementById('timeline-slider').value]}
function initAudio(){if(State.audio.ctx)return;const AC=window.AudioContext||window.webkitAudioContext;State.audio.ctx=new AC();State.audio.analyser=State.audio.ctx.createAnalyser();State.audio.analyser.fftSize=256;State.audio.osc=State.audio.ctx.createOscillator();State.audio.gain=State.audio.ctx.createGain();State.audio.osc.connect(State.audio.gain);State.audio.gain.connect(State.audio.analyser);State.audio.analyser.connect(State.audio.ctx.destination);State.audio.osc.start();State.audio.gain.gain.value=0}
function toggleAudio(){
    if(!State.audio.ctx)initAudio();
    // Resume context on user gesture
    if(State.audio.ctx.state==='suspended') State.audio.ctx.resume();
    State.audio.enabled=!State.audio.enabled;
    document.getElementById('btn-audio').innerHTML=State.audio.enabled?'<i class="fas fa-volume-up text-cyan-400"></i>':'<i class="fas fa-volume-mute text-xs opacity-70"></i>';
    showToast(State.audio.enabled?"Audio ON":"Audio OFF")
}
function updateAudio(val){if(!State.audio.enabled)return;State.audio.osc.frequency.setTargetAtTime(Math.max(50,Math.min(1000,200+val*100)),State.audio.ctx.currentTime,0.1);State.audio.gain.gain.setTargetAtTime(0.05,State.audio.ctx.currentTime,0.1)}
function drawSpectrum(){if(!State.audio.analyser)return;const w=specCvs.width,h=specCvs.height,c=specCvs.getContext('2d');const d=new Uint8Array(State.audio.analyser.frequencyBinCount);State.audio.analyser.getByteFrequencyData(d);c.clearRect(0,0,w,h);for(let i=0,x=0;i<d.length;i++){let bh=d[i]/2;c.fillStyle=`rgb(${bh+100},50,150)`;c.fillRect(x,h-bh,(w/d.length)*2.5,bh);x+=(w/d.length)*2.5+1}}
async function runBifurcation(){const c=document.getElementById('bifCanvas').getContext('2d'),w=bifCvs.width,h=bifCvs.height;c.fillStyle='#000';c.fillRect(0,0,w,h);document.getElementById('bif-overlay').classList.remove('hidden');const st=100,tr=500,sa=200,ot=State.params.tau;c.strokeStyle='#333';c.beginPath();c.moveTo(0,h/2);c.lineTo(w,h/2);c.stroke();for(let i=0;i<st;i++){let ct=(i/st)*100,sx=[1],sv=[0];for(let t=0;t<tr+sa;t++){let idx=Math.floor(ct),xo=(idx<sx.length)?sx[idx]:0,dx=0;if(State.activeAlgo.type.includes('MACKEY')){let beta=State.params.k*2;dx=(beta*xo)/(1+Math.pow(xo,10))-0.1*sx[0];sx.unshift(sx[0]+dx*0.1)}else{let a=-State.params.k*xo-0.05*sv[0];sv.unshift(sv[0]+a*0.1);sx.unshift(sx[0]+sv[0]*0.1)}if(sx.length>200){sx.pop();if(sv.length>0)sv.pop()}if(t>tr&&sx[1]>sx[0]&&sx[1]>sx[2]){c.fillStyle='#4ade80';c.fillRect((i/st)*w,h/2-sx[1]*(h/4),1,1)}}document.getElementById('scan-progress').innerText=Math.round((i/st)*100)+'%';await new Promise(r=>setTimeout(r,0))}document.getElementById('bif-overlay').classList.add('hidden');State.params.tau=ot}
function initChart(){if(chartObj)chartObj.destroy();chartObj=new Chart(document.getElementById('graphCanvas').getContext('2d'),{type:'line',data:{labels:[],datasets:[{label:'X',data:[],borderColor:'#06b6d4',borderWidth:2,pointRadius:0}]},options:{responsive:true,maintainAspectRatio:false,animation:false,scales:{x:{display:false},y:{grid:{color:'#333'}}},plugins:{legend:{display:false}}}})}
function initSeriesChart(){if(seriesChart)seriesChart.destroy();seriesChart=new Chart(document.getElementById('seriesCanvas').getContext('2d'),{type:'line',data:{labels:[],datasets:[{label:'Exact',data:[],borderColor:'#4ade80',borderWidth:2,pointRadius:0},{label:'Approx',data:[],borderColor:'#f472b6',borderDash:[5,5],borderWidth:2,pointRadius:0}]},options:{responsive:true,maintainAspectRatio:false,animation:false,scales:{x:{display:false},y:{grid:{color:'#333'}}}}})}
function initCompareChart(){if(compareChart)compareChart.destroy();compareChart=new Chart(document.getElementById('compareCanvas').getContext('2d'),{type:'line',data:{labels:[],datasets:[{label:'Newton',data:[],borderColor:'#60a5fa',borderWidth:2,pointRadius:0},{label:'Raju',data:[],borderColor:'#e879f9',borderWidth:2,pointRadius:0}]},options:{responsive:true,maintainAspectRatio:false,animation:false,scales:{x:{display:false},y:{grid:{color:'#333'}}},plugins:{legend:{display:false}}}})}
function updateCharts(){if(chartObj&&!document.getElementById('tab-graph').classList.contains('hidden')){chartObj.data.labels.push(State.t);chartObj.data.datasets[0].data.push(State.history.x[0]||0);if(chartObj.data.labels.length>50){chartObj.data.labels.shift();chartObj.data.datasets[0].data.shift()}chartObj.update('none')}if(seriesChart&&!document.getElementById('tab-series').classList.contains('hidden')){let l,e,a=0,x=State.t*0.1;if(State.activeAlgo.id==='series_sin'){for(let n=0;n<State.params.terms;n++)a+=(Math.pow(-1,n)*Math.pow(x,2*n+1))/factorial(2*n+1);e=Math.sin(x);l=x.toFixed(1)}else{for(let n=0;n<State.params.terms;n++)a+=4*(Math.pow(-1,n))/(2*n+1);e=Math.PI;l=State.t}seriesChart.data.labels.push(l);seriesChart.data.datasets[0].data.push(e);seriesChart.data.datasets[1].data.push(a);if(seriesChart.data.labels.length>30){seriesChart.data.labels.shift();seriesChart.data.datasets.forEach(d=>d.data.shift())}seriesChart.update('none')}if(compareChart&&!document.getElementById('tab-compare').classList.contains('hidden')&&State.history.x_pde.length>0){compareChart.data.labels.push(State.t);compareChart.data.datasets[0].data.push(State.history.x_pde[0]);compareChart.data.datasets[1].data.push(State.history.x[0]);if(compareChart.data.labels.length>50){compareChart.data.labels.shift();compareChart.data.datasets.forEach(d=>d.data.shift())}compareChart.update('none')}}
function factorial(n){if(n<=1)return 1;let r=1;for(let i=2;i<=n;i++)r*=i;return r}
function setupInteractions(){const h=e=>{if(State.activeAlgo.type==='REACTION_DIFFUSION'){let r=cvs.getBoundingClientRect(),x=(e.touches?e.touches[0].clientX:e.clientX)-r.left,y=(e.touches?e.touches[0].clientY:e.clientY)-r.top,ix=Math.floor(x/r.width*64),iy=Math.floor(y/r.height*64);State.gs.v[iy*64+ix]=1}if(!State.activeAlgo.type.includes('WAVE')&&!State.activeAlgo.type.includes('THERMO'))return;const r=cvs.getBoundingClientRect(),x=(e.touches?e.touches[0].clientX:e.clientX)-r.left,i=Math.floor(x/r.width*100);if(i>=0&&i<100)State.grid[i]=1.0};cvs.addEventListener('mousedown',h);cvs.addEventListener('touchmove',h)}
function populateHome(){const l=document.getElementById('algo-list');l.innerHTML='';Object.keys(ALGO_DB).forEach(cat=>{let s=document.createElement('div');s.innerHTML=`<h3 class="text-[9px] font-bold opacity-60 mb-2 ml-1 border-l-2 border-cyan-500 pl-2 uppercase tracking-widest sticky top-0 bg-black/80 backdrop-blur z-20 py-1">${cat}</h3>`;let g=document.createElement('div');g.className='grid grid-cols-1 gap-2 mb-6';ALGO_DB[cat].forEach(algo=>{let b=document.createElement('button');b.className='bg-white/5 border border-white/5 p-3 rounded-lg flex justify-between items-center active:bg-white/10 transition group hover:border-cyan-500/30 hover:bg-white/10';b.innerHTML=`<div class="text-left"><div class="font-bold text-xs group-hover:text-cyan-400 transition">${algo.title}</div><div class="text-[9px] opacity-60 font-mono mt-0.5">${algo.type}</div></div><div class="w-7 h-7 rounded-full bg-black flex items-center justify-center text-cyan-500 group-hover:bg-cyan-500 group-hover:text-black transition shadow-lg"><i class="fas fa-play text-[9px]"></i></div>`;b.onclick=()=>launchSim(algo);g.appendChild(b)});s.appendChild(g);l.appendChild(s)})}
window.exportCSV=()=>{let c="Time,X,V\n",l=Math.min(State.history.x.length,1000);for(let i=0;i<l;i++)c+=`${i},${State.history.x[i]},${State.history.v[i]}\n`;const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([c],{type:'text/csv'}));a.download='data.csv';a.click()}
window.exportPDF=()=>{const{jsPDF}=window.jspdf,d=new jsPDF();d.setFillColor(15,23,42);d.rect(0,0,210,40,'F');d.setTextColor(255,255,255);d.text("Scientific Report",10,15);d.setFontSize(10);d.text(`Sim: ${State.activeAlgo.title}`,10,25);d.setTextColor(0,0,0);let r=[],l=Math.min(State.history.x.length,50);for(let i=0;i<l;i++)r.push([i,State.history.x[i].toFixed(4),State.history.v[i].toFixed(4)]);d.autoTable({head:[['t','x','v']],body:r,startY:50});d.save('report.pdf')}
window.exportGraphPDF=(id)=>{const{jsPDF}=window.jspdf,d=new jsPDF('landscape');d.setFillColor(0,0,0);d.rect(0,0,297,210,'F');d.addImage(document.getElementById(id).toDataURL('image/png'),'PNG',10,10,280,150);d.setTextColor(255,255,255);d.text(`Snapshot: ${State.activeAlgo.title}`,10,170);d.save('Snapshot.pdf')}

// BOOT
init();
</script>
</body>
</html>
