<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>KalaSimX</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; font-family: 'Segoe UI', sans-serif; background-color: #0f172a; color: white; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        canvas { touch-action: none; border-radius: 12px; border: 1px solid #334155; }
        .gold-t { color: #fbbf24; font-weight: bold; font-family: monospace; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body>

<div id="root" class="w-full h-[100dvh] flex flex-col max-w-md mx-auto bg-slate-900 shadow-2xl relative overflow-hidden"></div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('sw.js').catch(e => console.log(e)));
    }
</script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

// --- ICONS ---
const Icons = {
    Menu: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,
    Back: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>,
    Calc: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="8" y2="6"/><line x1="16" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="8" y2="10"/><line x1="16" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="16" y2="18"/></svg>,
    Install: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
};

// --- DATA CONTENT ---
const SIMS = [
    { id: 'mech', title: 'Classical Mechanics', eq: ['x(', 't', ') = v₀', 't', ' + ½a', 't', '²'], desc: 'Projectile Motion', color: 'text-blue-400' },
    { id: 'wave', title: 'Wave Dynamics', eq: ['y(x,', 't', ') = A sin(ω', 't', ' - kx)'], desc: 'Standing Waves', color: 'text-purple-400' },
    { id: 'em', title: 'Electromagnetism', eq: ['V(', 't', ') = V₀ sin(ω', 't', ')'], desc: 'AC Circuits', color: 'text-yellow-400' },
    { id: 'optics', title: 'Optics', eq: ['c = d / ', 't'], desc: 'Light Speed', color: 'text-teal-400' },
    { id: 'thermo', title: 'Thermodynamics', eq: ['Q = mcΔT / ', 't'], desc: 'Heat Flow', color: 'text-orange-400' },
];

// --- 1. DIFFERENTIAL EQUATION SOLVER ---
const DiffEqSolver = () => {
    const canvasRef = useRef(null);
    const [k, setK] = useState(0.1); 
    
    useEffect(() => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        const w = canvas.width = canvas.parentElement.clientWidth;
        const h = canvas.height = 200;
        
        ctx.fillStyle = '#1e293b'; ctx.fillRect(0,0,w,h);
        
        // Grid
        ctx.strokeStyle = '#334155'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); ctx.stroke(); // X-axis
        
        // Plot: Simple Harmonic Motion (d2y/dt2 = -ky)
        ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 3; ctx.beginPath();
        ctx.moveTo(0, h/2);
        
        for(let x=0; x<w; x++) {
            const t = x * 0.1;
            const y = 80 * Math.exp(-k * t) * Math.cos(t); // Damped Oscillation
            ctx.lineTo(x, h/2 - y);
        }
        ctx.stroke();

        ctx.fillStyle = '#94a3b8'; ctx.font = "12px monospace";
        ctx.fillText("Solving Damped Oscillation:", 10, 20);
    }, [k]);

    return (
        <div className="glass-panel p-4 rounded-xl mb-6">
            <h3 className="font-bold text-lg mb-2 text-white flex items-center gap-2">
                <Icons.Calc /> Differential Eq. Solver
            </h3>
            <div className="rounded-lg overflow-hidden mb-4">
                <canvas ref={canvasRef} className="w-full h-[200px]" />
            </div>
            <div className="flex items-center gap-4">
                <span className="text-xs text-slate-400 font-mono">Damping (k):</span>
                <input type="range" min="0.01" max="0.2" step="0.01" value={k} onChange={e=>setK(e.target.value)} className="flex-1 accent-yellow-500"/>
            </div>
        </div>
    );
};

// --- 2. SIMULATION CANVAS ---
const SimCanvas = ({ type }) => {
    const canvasRef = useRef(null);
    useEffect(() => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        let t = 0; let id;
        
        const render = () => {
            t += 0.05; 
            const w = canvas.width = canvas.parentElement.clientWidth;
            const h = canvas.height = 240;
            const cx = w/2, cy = h/2;
            
            ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,w,h);
            ctx.fillStyle = '#fbbf24'; ctx.font = "12px monospace"; ctx.fillText(`t = ${t.toFixed(1)}`, 10, h-10);

            if(type === 'mech') {
                const x = (t * 40) % w;
                const y = cy + 60 * Math.sin(t*3) * Math.exp(-0.1*t); // Damped
                ctx.beginPath(); ctx.arc(x, y, 6, 0, 7); ctx.fillStyle='#60a5fa'; ctx.fill();
                ctx.strokeStyle='#334155'; ctx.beginPath(); ctx.moveTo(0,cy); ctx.lineTo(w,cy); ctx.stroke();
            }
            if(type === 'wave') {
                ctx.beginPath(); ctx.strokeStyle='#c084fc'; ctx.lineWidth=2;
                for(let x=0; x<w; x+=2) { ctx.lineTo(x, cy + 40 * Math.sin(x*0.05 - t*3)); }
                ctx.stroke();
            }
            if(type === 'em') {
                 ctx.strokeStyle='#facc15'; ctx.lineWidth=2;
                 ctx.beginPath();
                 for(let x=0; x<w; x++) { ctx.lineTo(x, cy - 50 * Math.sin(x*0.1 + t*4)); }
                 ctx.stroke();
                 ctx.strokeStyle='#ef4444'; ctx.beginPath();
                 for(let x=0; x<w; x++) { ctx.lineTo(x, cy - 50 * Math.cos(x*0.1 + t*4)); } // E vs B field
                 ctx.stroke();
            }
            if(type === 'thermo') {
                for(let i=0; i<50; i++) {
                    const x = (Math.sin(t*0.1 + i)*0.5 + 0.5) * w; 
                    const y = (Math.cos(t*0.15 + i*2)*0.5 + 0.5) * h;
                    ctx.beginPath(); ctx.arc(x,y,2,0,7); ctx.fillStyle = i%2?'#fbbf24':'#f87171'; ctx.fill();
                }
            }
            if(type === 'optics') {
                const lx = (t*20)%w;
                ctx.beginPath(); ctx.arc(lx, cy, 3, 0, 7); ctx.fillStyle='#2dd4bf'; ctx.fill();
                ctx.fillStyle='#fff'; ctx.fillText("Photon", lx, cy-10);
            }
            
            id = requestAnimationFrame(render);
        };
        render(); return () => cancelAnimationFrame(id);
    }, [type]);
    return <div className="rounded-xl overflow-hidden mt-4 shadow-lg border border-slate-700"><canvas ref={canvasRef} className="block w-full h-[240px]"/></div>;
};

// --- 3. MAIN APP ---
const App = () => {
    const [view, setView] = useState('home');
    const [sim, setSim] = useState(null);
    const [installPrompt, setInstallPrompt] = useState(null);

    useEffect(() => {
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); // Prevent automatic mini-infobar
            setInstallPrompt(e); // Save event for button click
        });
    }, []);

    const handleInstall = async () => {
        if(installPrompt) {
            installPrompt.prompt();
            const { outcome } = await installPrompt.userChoice;
            if(outcome === 'accepted') setInstallPrompt(null);
        } else {
            alert("App already installed or not supported. Check your App Drawer!");
        }
    };

    // Helper to highlight 't' in gold
    const Equation = ({ parts }) => (
        <div className="font-mono text-sm text-slate-300">
            {parts.map((part, i) => part === 't' ? <span key={i} className="gold-t">t</span> : <span key={i}>{part}</span>)}
        </div>
    );

    return (
        <div className="flex flex-col h-full bg-slate-900 text-slate-100">
            {/* Header */}
            <div className="flex items-center justify-between p-4 bg-slate-900/90 backdrop-blur sticky top-0 z-20 border-b border-slate-800">
                <div className="flex items-center gap-3" onClick={() => setView('home')}>
                    <div className="w-9 h-9 rounded-full bg-black border border-yellow-500 overflow-hidden">
                        <img src="KalaSimX.jpg" className="w-full h-full object-cover" onError={(e) => e.target.style.display='none'} />
                    </div>
                    <span className="font-bold tracking-wide">KalaSimX</span>
                </div>
            </div>

            <main className="flex-1 overflow-y-auto p-4 pb-12">
                {view === 'home' && (
                    <div className="space-y-6 animate-in fade-in duration-500">
                        {/* Hero Section */}
                        <div className="glass-panel p-6 rounded-2xl text-center relative overflow-hidden">
                            <img src="KalaSimX.jpg" className="w-24 h-24 rounded-full mx-auto mb-4 border-2 border-yellow-500 shadow-2xl object-cover" />
                            <h1 className="text-2xl font-bold text-white mb-1">KalaSimX</h1>
                            <p className="text-xs text-yellow-500 tracking-widest uppercase mb-6">Kalachakra Dynamics</p>
                            
                            {/* DIRECT INSTALL BUTTON */}
                            <button onClick={handleInstall} className="w-full py-3 bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-black font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform">
                                <Icons.Install /> Install App
                            </button>
                        </div>

                        {/* Modules */}
                        <div>
                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">Simulation Modules</h3>
                            <div className="grid gap-3">
                                {/* Diff Eq Button */}
                                <button onClick={() => setView('diffeq')} className="glass-panel p-4 rounded-xl flex items-center gap-4 active:bg-slate-800 transition text-left">
                                    <div className="w-10 h-10 rounded-lg bg-red-600/20 text-red-500 flex items-center justify-center border border-red-500/30"><Icons.Calc /></div>
                                    <div>
                                        <div className="font-bold text-sm">Differential Solver</div>
                                        <div className="text-xs text-slate-400">Numerical Solutions</div>
                                    </div>
                                </button>

                                {/* Sim Buttons */}
                                {SIMS.map(s => (
                                    <button key={s.id} onClick={() => { setSim(s); setView('sim'); }} className="glass-panel p-4 rounded-xl flex items-center gap-4 active:bg-slate-800 transition text-left">
                                        <div className={`w-10 h-10 rounded-lg bg-slate-800 flex items-center justify-center font-bold font-mono ${s.color}`}>t</div>
                                        <div>
                                            <div className="font-bold text-sm">{s.title}</div>
                                            <Equation parts={s.eq} />
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                )}

                {view === 'sim' && sim && (
                    <div className="animate-in slide-in-from-right duration-300">
                        <button onClick={() => setView('home')} className="flex items-center gap-2 text-slate-400 mb-4 font-bold text-xs uppercase tracking-wide"><Icons.Back /> Back to Modules</button>
                        <h2 className="text-2xl font-bold text-white mb-2">{sim.title}</h2>
                        <div className="bg-slate-800 p-3 rounded-lg border border-slate-700 mb-4"><Equation parts={sim.eq} /></div>
                        
                        <SimCanvas type={sim.id} />
                        
                        <div className="mt-4 text-sm text-slate-400 leading-relaxed bg-slate-800/50 p-4 rounded-xl">
                            Visualizing the flow of time (<span className="gold-t">t</span>). Notice how the system state evolves as <span className="gold-t">t</span> progresses forward.
                        </div>
                    </div>
                )}

                {view === 'diffeq' && (
                    <div className="animate-in slide-in-from-right duration-300">
                        <button onClick={() => setView('home')} className="flex items-center gap-2 text-slate-400 mb-4 font-bold text-xs uppercase tracking-wide"><Icons.Back /> Back to Modules</button>
                        <DiffEqSolver />
                        <div className="text-xs text-slate-500 mt-4 text-center">Using numerical integration to solve dy/dt in real-time.</div>
                    </div>
                )}
            </main>
        </div>
    );
};
const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
</script>
</body>
</html>
